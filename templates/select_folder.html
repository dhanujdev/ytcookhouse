{% extends "base.html" %}

{% block title %}Select Recipe - YT AutoHouse{% endblock %}

{% block content %}
    <section id="select-recipe">
        <hgroup>
            <h2>Select a Recipe to Process</h2>
            <h3>Choose a recipe folder from your Google Drive.</h3>
        </hgroup>

        {% if request.query_params.get("message") %}
            <div class="message-container success">
                {{ request.query_params.get("message").replace("_", " ") }}
            </div>
        {% endif %}
        {% if request.query_params.get("error") %}
            <div class="message-container error">
                 {{ request.query_params.get("error").replace("_", " ") }}
            </div>
        {% endif %}

        {% if folders %}
            <form action="{{ url_for('fetch_clips_route') }}" method="post">
                <fieldset>
                    <legend>Available Google Drive Recipes</legend>
                    {% for folder in folders %}
                    <label for="{{ folder.id }}">
                        <input type="radio" id="{{ folder.id }}" name="folder_id" value="{{ folder.id }}" required
                               {% if folder.status_from_db == 'Uploaded' or (folder.status_from_db and 'Failed' in folder.status_from_db) %}disabled aria-disabled="true"{% endif %}>
                        {{ folder.display_name }}
                        {% if folder.status_from_db == 'Uploaded' and folder.youtube_url %}
                            <small>(<a href="{{ folder.youtube_url }}" target="_blank">View on YouTube <mark>✅</mark></a>)</small>
                        {% elif folder.status_from_db and 'Failed' in folder.status_from_db %}
                            <small>(Processing Failed <mark>❌</mark> - Check logs for details: {{ folder.get('error_message', 'N/A') | truncate(50) }})</small>
                        {% elif folder.status_from_db and folder.status_from_db not in ['New', 'Downloaded', 'Unknown', None] %}
                             <small>(Status: {{ folder.status_from_db }})</small>
                        {% endif %}
                    </label>
                    <input type="hidden" name="folder_name_for_{{ folder.id }}" value="{{ folder.name }}">
                    {% endfor %}
                </fieldset>
                
                <button type="submit" class="contrast">Download & Process Selected Recipe</button>
            </form>
            <!-- JavaScript to dynamically set the folder_name based on selected folder_id -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.querySelector('form');
                    const radioButtons = form.querySelectorAll('input[type="radio"][name="folder_id"]');

                    form.addEventListener('submit', function(event) {
                        let selectedFolderId = null;
                        radioButtons.forEach(radio => {
                            if (radio.checked) {
                                selectedFolderId = radio.value;
                            }
                        });

                        if (selectedFolderId) {
                            const folderNameInput = form.querySelector(`input[type="hidden"][name="folder_name_for_${selectedFolderId}"]`);
                            if (folderNameInput) {
                                const existingFolderName = form.querySelector('input[type="hidden"][name="folder_name"]');
                                if (existingFolderName) {
                                    existingFolderName.remove();
                                }
                                const newFolderNameInput = document.createElement('input');
                                newFolderNameInput.type = 'hidden';
                                newFolderNameInput.name = 'folder_name';
                                newFolderNameInput.value = folderNameInput.value;
                                form.appendChild(newFolderNameInput);
                            } else {
                                alert('Could not find the folder name for the selected ID. Please refresh and try again.');
                                event.preventDefault(); // Stop submission
                                return;
                            }
                        } else {
                            alert('Please select a recipe folder to process.');
                            event.preventDefault(); // Stop submission
                            return;
                        }
                    });
                });
            </script>
        {% else %}
            <article>
                <header>No recipe folders found</header>
                <p>No unprocessed recipe folders were found in your Google Drive, or there was an error fetching them.</p>
                <p>Please ensure recipe folders are in the configured Google Drive source folder, or try refreshing the page.</p>
                <footer><a href="{{ url_for('home') }}" role="button" class="secondary">Back to Home</a></footer>
            </article>
        {% endif %}
    </section>
{% endblock %}