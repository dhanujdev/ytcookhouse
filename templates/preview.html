{% extends "base.html" %}

{% block title %}Preview: {{ recipe_name_display if recipe_name_display else recipe_name_safe }} - YT AutoHouse{% endblock %}

{% block content %}
    <article>
        <header>
            <hgroup>
                <h2>Video & Metadata Preview</h2>
                <h3>Recipe: {{ recipe_name_display if recipe_name_display else recipe_name_safe }}</h3>
            </hgroup>
        </header>

        {% if error_message %}
            <div class="message-container error">
                <p><strong>Error loading preview:</strong></p>
                <p>{{ error_message }}</p>
            </div>
            <footer><a href="{{ url_for('select_folder_route') }}" role="button" class="secondary">Back to Recipe Selection</a></footer>
        {% elif video_url and metadata %}
            <figure>
                <video controls preload="metadata" src="{{ video_url }}">
                    Your browser does not support the video tag. Consider using a modern browser.
                </video>
                {% if video_url %}
                <figcaption><small>Video file: {{ video_url.split('/')[-1] }}</small></figcaption>
                {% endif %}
            </figure>

            <hr>

            <form action="{{ url_for('upload_to_youtube_route') }}" method="post">
                <input type="hidden" name="recipe_db_id" value="{{ recipe_db_id }}">
                <input type="hidden" name="recipe_name_safe" value="{{ recipe_name_safe }}">
                
                <h3>Edit YouTube Metadata</h3>

                <label for="title">Title</label>
                <input type="text" id="title" name="title" value="{{ metadata.title }}" required>

                <label for="description">Description</label>
                <textarea id="description" name="description" rows="10" required>{{ metadata.description }}</textarea>

                <label for="tags">Tags (comma-separated)</label>
                <input type="text" id="tags" name="tags" value="{{ metadata.tags | join(', ') if metadata.tags else '' }}">
                
                <details open> <!-- Chapters open by default -->
                    <summary>Generated Chapters (for reference)</summary>
                    {% if metadata.chapters and metadata.chapters|length > 0 %}
                        <ul>
                        {% for chapter in metadata.chapters %}
                            <li><code>{{ chapter.time }}</code> - {{ chapter.label }}</li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p><small>No chapters were generated or found in the metadata.</small></p>
                    {% endif %}
                </details>
            
                <details>
                    <summary>View/Hide Transcript Preview (first ~500 characters)</summary>
                    <pre><small>{{ metadata.transcript | truncate(500, True) if metadata.transcript else 'No transcript was generated or found.' }}</small></pre>
                </details>
                
                <hr>
                <button type="submit" class="contrast">Confirm & Upload to YouTube</button>
            </form>
            
            <footer style="margin-top: 2rem;">
                <a href="{{ url_for('select_folder_route') }}" role="button" class="secondary outline">Cancel & Process Another Recipe</a>
            </footer>
        {% else %}
            <div class="message-container error">
                 <p>Could not load video or metadata for preview. Please try selecting the folder again.</p>
            </div>
            <footer><a href="{{ url_for('select_folder_route') }}" role="button" class="secondary">Back to Recipe Selection</a></footer>
        {% endif %}
    </article>
{% endblock %}